version: 2

jobs:
    build:
        resource_class: medium+
        docker:
            - image: nikolaik/python-nodejs:python3.7-nodejs8
        environment:
            CONTRACTS_COMMIT_HASH: '9ed05f5'
        working_directory: ~/repo
        steps:
            - checkout
            - restore_cache:
                  key: yarn-cache-{{ checksum "yarn.lock" }}
            - run: git fetch --force origin development:development
            - run: git --no-pager diff HEAD..development
            - run: echo 'export PATH=$HOME/CIRCLE_PROJECT_REPONAME/node_modules/.bin:$PATH' >> $BASH_ENV
            - run:
                  name: install-yarn
                  command: npm install --force --global yarn@1.17.0
            - run: yarn cache dir
            - run:
                  name: yarn
                  command: yarn --frozen-lockfile --ignore-engines install
            - run: yarn wsrun --changedSince development --report --stages --fast-exit --exclude-missing --bin echo -c abcd
            - run: yarn build:ci:dirty
            - run: yarn test:ci:dirty
            - save_cache:
                  when: always
                  key: yarn-cache-{{ checksum "yarn.lock" }}
                  paths:
                      - /usr/local/share/.cache/yarn/v4
workflows:
    version: 2
    main:
        jobs:
            - build
