version: 2

jobs:
  build:
    docker:
      - image: circleci/node:9.11
    environment:
      CONTRACTS_COMMIT_HASH: '9ed05f5'
    working_directory: ~/repo
    steps:
      - checkout
      - run: echo 'export PATH=$HOME/CIRCLE_PROJECT_REPONAME/node_modules/.bin:$PATH' >> $BASH_ENV
      - restore_cache:
          key: dependency-cache-{{ checksum "package.json" }}
      - run: yarn --frozen-lockfile
      - save_cache:
          key: dependency-cache-{{ checksum "package.json" }}
          paths:
            - ./node_modules
      - run: yarn lerna bootstrap
      - run: yarn build
      - run: yarn test
      - run: yarn test:installation
      - run: yarn lint
      - run: yarn prettier:ci
      - save_cache:
          key: repo-{{ .Environment.CIRCLE_SHA1 }}
          paths:
            - ~/repo
  test:
    docker:
      - image: circleci/node:9.11
    working_directory: ~/repo
    steps:
      - restore_cache:
          keys:
            - repo-{{ .Environment.CIRCLE_SHA1 }}
      - run: yarn test
      - save_cache:
          key: coverage-test-{{ .Environment.CIRCLE_SHA1 }}
          paths:
            - ~/repo
  test-installation:
    docker:
      - image: circleci/node:9.11
    working_directory: ~/repo
    steps:
      - restore_cache:
          keys:
            - repo-{{ .Environment.CIRCLE_SHA1 }}
      - run: yarn test:installation
      - save_cache:
          key: coverage-test-installation-{{ .Environment.CIRCLE_SHA1 }}
          paths:
            - ~/repo
  lint:
    working_directory: ~/repo
    docker:
      - image: circleci/node:9.11
    steps:
      - restore_cache:
          keys:
            - repo-{{ .Environment.CIRCLE_SHA1 }}
      - run: yarn lint
  prettier:
    working_directory: ~/repo
    docker:
      - image: circleci/node:9.11
    steps:
      - restore_cache:
          keys:
            - repo-{{ .Environment.CIRCLE_SHA1 }}
      - run: yarn prettier:ci
  submit-coverage:
    docker:
      - image: circleci/node:9.11
    working_directory: ~/repo
    steps:
      - restore_cache:
          keys:
            - repo-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          keys:
            - coverage-contracts-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          keys:
            - coverage-assert-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          keys:
            - coverage-connect-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          keys:
            - coverage-dev-utils-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          keys:
            - coverage-json-schemas-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          keys:
            - coverage-subproviders-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          keys:
            - coverage-sol-cov-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          keys:
            - coverage-sol-compiler-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          keys:
            - coverage-0xjs-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          keys:
            - coverage-metacoin-{{ .Environment.CIRCLE_SHA1 }}
      - run: yarn report_coverage
workflows:
  version: 2
  main:
    jobs:
      - build
      - test:
          requires:
            - build
      - test-installation:
          requires:
            - build
      - lint:
          requires:
            - build
      - lint:
          requires:
            - build
      - prettier:
          requires:
            - build
      - submit-coverage:
          requires:
            - test-0xjs
            - test-sol-compiler
            - test-rest
            - test-contracts
